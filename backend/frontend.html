<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Negotiation Simulator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind CDN (for quick styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root" class="max-w-5xl mx-auto p-6"></div>

    <script type="text/javascript">
      const { useState } = React;
      const {
        LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
      } = Recharts;

      function App() {
        const [form, setForm] = useState({
          buyer_name: "AnalyticalBuyer",
          buyer_budget: 200000,
          seller_min: 150000,
          max_rounds: 10,
          product: {
            name: "Alphonso Mangoes",
            category: "Mangoes",
            quantity: 100,
            quality_grade: "A",
            origin: "Ratnagiri",
            base_market_price: 180000,
            attributes: { ripeness: "optimal", export_grade: true }
          }
        });

        const [loading, setLoading] = useState(false);
        const [result, setResult] = useState(null);
        const [error, setError] = useState("");

        const onChange = (e) => {
          const { name, value } = e.target;
          if (name in form) {
            setForm({ ...form, [name]: isNaN(value) ? value : Number(value) });
          }
        };

        const onProductChange = (e) => {
          const { name, value } = e.target;
          setForm({
            ...form,
            product: {
              ...form.product,
              [name]: isNaN(value) ? value : Number(value),
            },
          });
        };

        const runSim = async () => {
          setLoading(true);
          setError("");
          setResult(null);
          try {
            const resp = await fetch("http://127.0.0.1:8000/simulate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(form),
            });
            if (!resp.ok) throw new Error("API error");
            const data = await resp.json();
            setResult(data);
          } catch (err) {
            setError("Failed to connect to backend. Is it running on :8000?");
          } finally {
            setLoading(false);
          }
        };

        return (
          React.createElement("div", { className: "space-y-6" },
            React.createElement("h1", { className: "text-2xl font-bold" }, "Negotiation Simulator"),
            React.createElement("p", { className: "text-gray-600" },
              "Visualize Buyer vs Seller offers per round and read the transcript."
            ),

            // Controls
            React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-4 rounded-2xl shadow" },
              React.createElement("div", { className: "space-y-3" },
                React.createElement("h2", { className: "font-semibold" }, "Buyer & Seller"),
                React.createElement("label", { className: "block text-sm text-gray-600" }, "Buyer Name"),
                React.createElement("input", {
                  className: "w-full border rounded p-2",
                  name: "buyer_name",
                  value: form.buyer_name,
                  onChange: onChange
                }),
                React.createElement("label", { className: "block text-sm text-gray-600" }, "Buyer Budget (₹)"),
                React.createElement("input", {
                  className: "w-full border rounded p-2",
                  type: "number",
                  name: "buyer_budget",
                  value: form.buyer_budget,
                  onChange: onChange
                }),
                React.createElement("label", { className: "block text-sm text-gray-600" }, "Seller Minimum (₹)"),
                React.createElement("input", {
                  className: "w-full border rounded p-2",
                  type: "number",
                  name: "seller_min",
                  value: form.seller_min,
                  onChange: onChange
                }),
                React.createElement("label", { className: "block text-sm text-gray-600" }, "Max Rounds"),
                React.createElement("input", {
                  className: "w-full border rounded p-2",
                  type: "number",
                  name: "max_rounds",
                  value: form.max_rounds,
                  onChange: onChange
                }),
              ),
              React.createElement("div", { className: "space-y-3" },
                React.createElement("h2", { className: "font-semibold" }, "Product"),
                React.createElement("label", { className: "block text-sm text-gray-600" }, "Name"),
                React.createElement("input", {
                  className: "w-full border rounded p-2",
                  name: "name",
                  value: form.product.name,
                  onChange: onProductChange
                }),
                React.createElement("label", { className: "block text-sm text-gray-600" }, "Market Price (₹)"),
                React.createElement("input", {
                  className: "w-full border rounded p-2",
                  type: "number",
                  name: "base_market_price",
                  value: form.product.base_market_price,
                  onChange: onProductChange
                }),
                React.createElement("label", { className: "block text-sm text-gray-600" }, "Quality Grade (A/B/Export)"),
                React.createElement("input", {
                  className: "w-full border rounded p-2",
                  name: "quality_grade",
                  value: form.product.quality_grade,
                  onChange: onProductChange
                }),
                React.createElement("label", { className: "block text-sm text-gray-600" }, "Origin"),
                React.createElement("input", {
                  className: "w-full border rounded p-2",
                  name: "origin",
                  value: form.product.origin,
                  onChange: onProductChange
                }),
              )
            ),

            React.createElement("div", { className: "flex gap-3" },
              React.createElement("button", {
                onClick: runSim,
                disabled: loading,
                className: "px-4 py-2 rounded-xl bg-black text-white shadow hover:opacity-90 disabled:opacity-50"
              }, loading ? "Running..." : "Start Negotiation"),
              error && React.createElement("span", { className: "text-red-600" }, error)
            ),

            result && React.createElement("div", { className: "space-y-6" },
              // Summary
              React.createElement("div", { className: "bg-white rounded-2xl shadow p-4" },
                React.createElement("h2", { className: "font-semibold mb-2" }, "Summary"),
                result.deal_made
                  ? React.createElement("div", { className: "space-y-1" },
                      React.createElement("div", null, `✅ DEAL at ₹${result.final_price.toLocaleString()} in ${result.rounds} rounds`),
                      React.createElement("div", null, `Savings vs Budget: ₹${result.savings_vs_budget.toLocaleString()} (${result.savings_pct_of_budget.toFixed(1)}%)`),
                      React.createElement("div", null, `Below Market: ${result.below_market_pct.toFixed(1)}%`)
                    )
                  : React.createElement("div", null, `❌ NO DEAL after ${result.rounds} rounds`)
              ),

              // Chart
              React.createElement("div", { className: "bg-white rounded-2xl shadow p-4 h-80" },
                React.createElement("h2", { className: "font-semibold mb-2" }, "Offers per Round"),
                React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                  React.createElement(LineChart, { data: result.chart, margin: { top: 5, right: 20, bottom: 5, left: 0 } },
                    React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                    React.createElement(XAxis, { dataKey: "round" }),
                    React.createElement(YAxis, null),
                    React.createElement(Tooltip, null),
                    React.createElement(Legend, null),
                    React.createElement(Line, { type: "monotone", dataKey: "buyer_offer", name: "Buyer Offer" }),
                    React.createElement(Line, { type: "monotone", dataKey: "seller_offer", name: "Seller Offer" })
                  )
                )
              ),

              // Transcript
              React.createElement("div", { className: "bg-white rounded-2xl shadow p-4" },
                React.createElement("h2", { className: "font-semibold mb-2" }, "Transcript"),
                React.createElement("div", { className: "space-y-2" },
                  result.transcript.map((m, idx) =>
                    React.createElement("div", {
                      key: idx,
                      className: "text-sm"
                    }, React.createElement("span", { className: "font-semibold" }, `[${m.role.toUpperCase()}] `), m.message)
                  )
                )
              )
            )
          )
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
    </script>
  </body>
</html>
